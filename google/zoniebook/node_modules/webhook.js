const { conversation } = require('@assistant/conversation');
const functions = require('firebase-functions');

const app = conversation();

app.intent("schedule", (conv, params, permissionGranted) => {
	if (permissionGranted) {
		const { requestedPermission } = conv.data;
		let address;
		if (requestedPermission === "DEVICE_PRECISE_LOCATION") {
			const { coordinates } = conv.device.location;
			console.log('coordinates are', coordinates);

			if (coordinates && address) {
				return conv.close(new SimpleResponse(`Your Location details ${address}`));
			} else {
				// Note: Currently, precise locaton only returns lat/lng coordinates on phones and lat/lng coordinates
				// and a geocoded address on voice-activated speakers.
				// Coarse location only works on voice-activated speakers.
				return conv.close("Sorry, I could not figure out where you are.");
			}
		}
	} else {
		return conv.close("Sorry, permission denied.");
	}
});


// app.handle('schedule', conv => {

//   const { location } = conv.device;
//   conv.add(new SimpleResponse(`Your address is ${location.formattedAddress}`));
//   // let tcity = conv.session.params.tcity;
//   // conv.add("Your meeting in " + tcity + " at {$session.params.ttime}");


// });

app.intent("Default Welcome Intent", conv => {
	conv.data.requestedPermission = "DEVICE_PRECISE_LOCATION";
	conv.ask(new SimpleResponse('Welcome to location tracker'));
	return conv.ask(
		new Permission({
			context: "to locate you",
			permissions: conv.data.requestedPermission
		})
	);
});

exports.ActionsOnGoogleFulfillment = functions.https.onRequest(app);
